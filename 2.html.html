
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê¸€ì±…ì“°ê¸° | ZITDA</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
</head>
<body class="bg-gray-50 font-sans h-screen">
  <div class="flex h-full">
    <!-- ì¢Œì¸¡: ëª©ì°¨ -->
    <aside class="w-1/3 bg-orange-50 border-r p-6 flex flex-col justify-between">
      <div>
        <h2 class="text-lg font-semibold text-orange-600 mb-4">ëª©ì°¨</h2>
        <ul id="titleList" class="space-y-2 text-sm text-gray-800 overflow-y-auto max-h-[70vh]"></ul>
      </div>
      <div class="space-y-2 pt-4 border-t mt-4">
        <button onclick="addNewTableOfContents()" class="w-full px-4 py-2 bg-orange-500 text-white rounded hover:bg-orange-600">ì €ì¥í•˜ê¸°</button>
        <button onclick="saveDraft()" class="w-full px-4 py-2 border border-orange-400 text-orange-600 rounded hover:bg-orange-50">ì„ì‹œ ì €ì¥</button>
        <button onclick="clearEditor()" class="w-full px-4 py-2 border text-gray-600 rounded hover:bg-gray-50">ìƒˆë¡œ ì“°ê¸°</button>
<button onclick="downloadAsDocx()" class="w-full px-4 py-2 border bg-white text-blue-700 rounded hover:bg-blue-100">ğŸ“„ ì „ì²´ Word ì €ì¥</button>
        <button onclick="downloadFullEPUB()" class="w-full px-4 py-2 border bg-white text-purple-700 rounded hover:bg-purple-100">ğŸ“˜ ì „ì²´ EPUB ì €ì¥</button>
      </div>
    </aside>

    <!-- ìš°ì¸¡: ê¸€ ì‘ì„± + AI -->
    <main class="flex-1 p-8 overflow-auto bg-white flex flex-col justify-between">
      <div>
        <div class="flex justify-between mb-4 text-sm text-gray-600 border-b pb-4">
          <div>
            <p><strong>ê¸€ì ìˆ˜:</strong> <span id="charCount" class="text-orange-600">0ì</span></p>
            <p><strong>ë¬¸ë‹¨ ìˆ˜:</strong> <span id="paraCount" class="text-orange-600">0ë¬¸ë‹¨</span></p>
          </div>
          <div><p>í˜•ì‹: ììœ í˜•</p></div>
        </div>
        <input id="title" type="text" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”." class="w-full text-2xl font-bold border-b pb-2 mb-4 focus:outline-none focus:border-orange-500">
        <textarea id="editor" rows="10" placeholder="ì—¬ê¸°ì— ê¸€ì„ ì“°ì„¸ìš”." class="w-full border rounded p-4 mb-4 resize-none focus:ring-2 focus:ring-orange-300"></textarea>
      </div>

      <!-- AI ë„ìš°ë¯¸ í•˜ë‹¨ 30% -->
      <div class="border-t pt-4 mt-4">
        <p class="text-orange-600 font-semibold mb-2">ğŸ§  AI ê¸€ì“°ê¸° ë„ìš°ë¯¸</p>
        <div class="flex flex-wrap gap-2 mb-3">
          <button onclick="runAI('ì•„ì´ë””ì–´')" class="px-4 py-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">ğŸ’¡ ì•„ì´ë””ì–´ í”¼ë“œë°±</button>
          <button onclick="runAI('ì£¼ì œ')" class="px-4 py-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">ğŸ¯ ì£¼ì œ í™•ì¥</button>
          <button onclick="runAI('ë§ì¶¤ë²•')" class="px-4 py-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">âœï¸ ë§ì¶¤ë²• ê²€ì‚¬</button>
          <button onclick="runAI('ë¬¸ì œì ')" class="px-4 py-2 bg-orange-100 text-orange-700 rounded hover:bg-orange-200">ğŸ§ ë¬¸ì œì  ë¶„ì„</button>
        </div>
        <div id="aiOutput" class="p-4 bg-gray-100 rounded text-sm text-gray-800 whitespace-pre-wrap h-40 overflow-y-auto"></div>
      </div>
    </main>
  </div>

  <script>
    const title = document.getElementById('title');
    const editor = document.getElementById('editor');
    const charCount = document.getElementById('charCount');
    const paraCount = document.getElementById('paraCount');

    function updateCounts() {
      const text = editor.value;
      charCount.textContent = text.replace(/\s/g, '').length + 'ì';
      paraCount.textContent = text.split(/\n+/).filter(p => p.trim() !== '').length + 'ë¬¸ë‹¨';
    }
    editor.addEventListener('input', updateCounts);

    function collectFormData() {
      return {
        title: title.value,
        content: editor.value,
      };
    }

    function saveDraft() {
      localStorage.setItem("draft", JSON.stringify(collectFormData()));
      alert("ì„ì‹œ ì €ì¥ ì™„ë£Œ!");
    }

    function clearEditor() {
      title.value = "";
      editor.value = "";
      updateCounts();
    }

    function addNewTableOfContents() {
      const data = collectFormData();
      if (!data.title || !data.content) {
        alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
      }
      const arr = JSON.parse(localStorage.getItem("savedTitles") || "[]");
      arr.push(data);
      localStorage.setItem("savedTitles", JSON.stringify(arr));
      updateTitleList();
      clearEditor();
    }

    function updateTitleList() {
      const list = document.getElementById("titleList");
      const arr = JSON.parse(localStorage.getItem("savedTitles") || "[]");
      list.innerHTML = "";
      arr.forEach((item, idx) => {
        const li = document.createElement("li");
        li.classList.add("border", "rounded", "px-3", "py-2", "bg-white", "shadow-sm", "cursor-pointer", "hover:bg-orange-50");
        li.textContent = item.title;
li.onclick = () => showPopup(item.title, item.content, idx);

        list.appendChild(li);
      });
    }

function showPopup(title, content, index) {
  const popup = document.createElement("div");
  popup.classList.add("fixed", "top-0", "left-0", "w-full", "h-full", "bg-black", "bg-opacity-40", "flex", "items-center", "justify-center", "z-50");

  popup.innerHTML = `
    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
      <h2 class="text-xl font-bold mb-4">${title}</h2>
      <textarea id="popupEditor" class="w-full border rounded p-4 h-64 resize-y mb-4">${content}</textarea>
      <div class="flex justify-end gap-2 flex-wrap">
        <button onclick="savePopupEdit(${index})" class="bg-green-100 text-green-700 px-4 py-2 rounded hover:bg-green-200">ğŸ’¾ ì €ì¥</button>
        <button onclick="deleteEntry(${index}); this.closest('.fixed').remove();" class="bg-red-100 text-red-700 px-4 py-2 rounded hover:bg-red-200">ğŸ—‘ ì‚­ì œ</button>
        <button onclick="downloadSingleEPUB('${title}', document.getElementById('popupEditor').value)" class="bg-purple-100 text-purple-700 px-4 py-2 rounded hover:bg-purple-200">ğŸ“˜ EPUB ì €ì¥</button>
        <button onclick="this.closest('.fixed').remove()" class="px-4 py-2 border rounded hover:bg-gray-100">ë‹«ê¸°</button>
      </div>
    </div>`;
  document.body.appendChild(popup);
}
function savePopupEdit(index) {
  const data = JSON.parse(localStorage.getItem("savedTitles") || "[]");
  const newContent = document.getElementById("popupEditor").value;
  if (data[index]) {
    data[index].content = newContent;
    localStorage.setItem("savedTitles", JSON.stringify(data));
    alert("ìˆ˜ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
    document.querySelector(".fixed").remove(); // íŒì—… ë‹«ê¸°
    updateTitleList(); // ê°±ì‹ 
  }
}

function downloadSingleEPUB(title, content) {
  const zip = new JSZip();

  // 1. ë°˜ë“œì‹œ ì²« ë²ˆì§¸ë¡œ mimetype íŒŒì¼ (ì••ì¶•X)
  zip.file("mimetype", "application/epub+zip", { compression: "STORE" });

  // 2. META-INF êµ¬ì¡°
  zip.folder("META-INF").file("container.xml", `<?xml version="1.0" encoding="UTF-8"?>
<container version="1.0"
  xmlns="urn:oasis:names:tc:opendocument:xmlns:container">
  <rootfiles>
    <rootfile full-path="OEBPS/content.opf"
              media-type="application/oebps-package+xml"/>
  </rootfiles>
</container>`);

  // 3. XHTML ë³¸ë¬¸ íŒŒì¼
  const formattedContent = content
    .split(/\\r?\\n+/)
    .map(line => `<p>${line.trim()}</p>`)
    .join("\\n");

  zip.folder("OEBPS").file("chapter1.xhtml", `<?xml version="1.0" encoding="UTF-8"?>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta charset="UTF-8" />
  <title>${title}</title>
</head>
<body>
  <h1>${title}</h1>
  ${formattedContent}
</body>
</html>`);

  // 4. content.opf êµ¬ì„±
  zip.folder("OEBPS").file("content.opf", `<?xml version="1.0" encoding="UTF-8"?>
<package version="2.0"
         xmlns="http://www.idpf.org/2007/opf"
         unique-identifier="bookid">
  <metadata xmlns:dc="http://purl.org/dc/elements/1.1/">
    <dc:title>${title}</dc:title>
    <dc:language>ko</dc:language>
    <dc:identifier id="bookid">id-${Date.now()}</dc:identifier>
  </metadata>
  <manifest>
    <item id="chap1" href="chapter1.xhtml" media-type="application/xhtml+xml"/>
  </manifest>
  <spine>
    <itemref idref="chap1"/>
  </spine>
</package>`);

  // 5. ZIP ìƒì„± ë° ë‹¤ìš´ë¡œë“œ
  zip.generateAsync({ type: "blob" }).then(blob => {
    saveAs(blob, `${title}.epub`);
  });
}
function deleteEntry(index) {
  const data = JSON.parse(localStorage.getItem("savedTitles") || "[]");
  data.splice(index, 1);
  localStorage.setItem("savedTitles", JSON.stringify(data));
  updateTitleList();
}

function editEntry(index) {
  const data = JSON.parse(localStorage.getItem("savedTitles") || "[]");
  if (data[index]) {
    title.value = data[index].title;
    editor.value = data[index].content;
    updateCounts();
  }
}

    function downloadFullEPUB() {
      const saved = JSON.parse(localStorage.getItem("savedTitles") || "[]");
      if (!saved.length) return alert("ì €ì¥ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");
      const zip = new JSZip();
      zip.file("mimetype", "application/epub+zip", { compression: "STORE" });
      zip.folder("META-INF").file("container.xml", `<?xml version="1.0" encoding="UTF-8"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);
      const manifest = [], spine = [];
      saved.forEach((item, i) => {
        zip.folder("OEBPS").file(`chapter${i + 1}.xhtml`, `<?xml version='1.0' encoding='UTF-8'?><html xmlns='http://www.w3.org/1999/xhtml'><head><title>${item.title}</title></head><body><h1>${item.title}</h1><p>${item.content.replace(/\n/g, "<br/>")}</p></body></html>`);
        manifest.push(`<item id="chap${i + 1}" href="chapter${i + 1}.xhtml" media-type="application/xhtml+xml"/>`);
        spine.push(`<itemref idref="chap${i + 1}"/>`);
      });
      zip.folder("OEBPS").file("content.opf", `<?xml version='1.0' encoding='UTF-8'?><package version='2.0' xmlns='http://www.idpf.org/2007/opf' unique-identifier='bookid'><metadata xmlns:dc='http://purl.org/dc/elements/1.1/'><dc:title>ZITDA ì „ì²´ ê¸€ì±…</dc:title><dc:language>ko</dc:language><dc:identifier id='bookid'>id-${Date.now()}</dc:identifier></metadata><manifest>${manifest.join("\n")}</manifest><spine>${spine.join("\n")}</spine></package>`);
      zip.generateAsync({ type: "blob" }).then(blob => saveAs(blob, "ì „ì²´_ê¸€ì±….epub"));
    }

    async function runAI(type) {
      const promptMap = {
        'ì•„ì´ë””ì–´': `ì´ ê¸€ì˜ ì•„ì´ë””ì–´ë¥¼ í™•ì¥í•´ì¤˜:

"${editor.value}"`,
        'ì£¼ì œ': `ì´ ê¸€ì˜ ì£¼ì œë¥¼ ë” ë„“ê²Œ í™•ì¥í•  ë°©ë²•ì„ ì œì•ˆí•´ì¤˜:

"${editor.value}"`,
        'ë§ì¶¤ë²•': `ë‹¤ìŒ ê¸€ì˜ ë§ì¶¤ë²•ì„ ê²€ì‚¬í•´ì¤˜:

"${editor.value}"`,
        'ë¬¸ì œì ': `ë‹¤ìŒ ê¸€ì˜ ë¬¸ì¥ íë¦„ì´ë‚˜ ë…¼ë¦¬ì  ë¬¸ì œì ì„ ì§€ì í•´ì¤˜:

"${editor.value}"`
      };
      const response = await fetch("https://api.openai.com/v1/chat/completions", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer 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`
        },
        body: JSON.stringify({
          model: "gpt-3.5-turbo",
          messages: [{ role: "user", content: promptMap[type] }],
          max_tokens: 800
        }),
      });
      const data = await response.json();
      document.getElementById("aiOutput").innerText = data.choices?.[0]?.message?.content || "AI ì‘ë‹µì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
    }

    window.onload = () => {
      const draft = JSON.parse(localStorage.getItem("draft") || "null");
      if (draft) {
        title.value = draft.title || "";
        editor.value = draft.content || "";
        updateCounts();
      }
      updateTitleList();
    };
  </script>
<!-- ğŸ“Œ ì´ ìœ„ì¹˜ê°€ ì ì ˆí•©ë‹ˆë‹¤ -->
<script src="https://unpkg.com/docx@8.0.0/build/index.js"></script>
<script>
  async function downloadAsDocx() {
    const { Document, Packer, Paragraph, TextRun } = window.docx;

    const saved = JSON.parse(localStorage.getItem("savedTitles") || "[]");
    if (!saved.length) return alert("ì €ì¥ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");

    const doc = new Document({
      sections: [{
        properties: {},
        children: saved.map(item => [
          new Paragraph({
            children: [new TextRun({ text: "ì œëª©: " + item.title, bold: true, size: 28 })],
            spacing: { after: 200 }
          }),
          new Paragraph({
            children: [new TextRun({ text: item.content, size: 24 })]
          }),
          new Paragraph({})
        ]).flat()
      }]
    });

    const blob = await Packer.toBlob(doc);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ì „ì²´_ê¸€ì±….docx";
    a.click();
  }
</script>
async function downloadSingleDocx(title, content) {
  const { Document, Packer, Paragraph, TextRun } = window.docx;

  const paragraphs = content
    .split(/\r?\n+/)  // ì¤„ë°”ê¿ˆ ê¸°ì¤€ìœ¼ë¡œ ë‚˜ëˆ”
    .filter(line => line.trim() !== "")
    .map(line =>
      new Paragraph({
        children: [new TextRun({ text: line, size: 24 })]
      })
    );

  const doc = new Document({
    sections: [{
      properties: {},
      children: [
        new Paragraph({
          children: [new TextRun({ text: "ì œëª©: " + title, bold: true, size: 28 })],
          spacing: { after: 200 }
        }),
        ...paragraphs
      ]
    }]
  });

  const blob = await Packer.toBlob(doc);
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = title + ".docx";
  a.click();
}

</body> <!-- ğŸ“Œ ì´ ì¤„ ë°”ë¡œ ìœ„ì— ì‚½ì…í•˜ì„¸ìš” -->
<script>
  async function downloadAsDocx() {
    const { Document, Packer, Paragraph, TextRun } = window.docx;

    const saved = JSON.parse(localStorage.getItem("savedTitles") || "[]");
    if (!saved.length) return alert("ì €ì¥ëœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.");

    const doc = new Document({
      sections: [{
        properties: {},
        children: saved.flatMap(item => {
          const titleParagraph = new Paragraph({
            children: [new TextRun({ text: "ì œëª©: " + item.title, bold: true, size: 28 })],
            spacing: { after: 200 }
          });

          const contentParagraphs = item.content
            .split(/\r?\n+/)
            .filter(line => line.trim() !== "")
            .map(line =>
              new Paragraph({
                children: [new TextRun({ text: line, size: 24 })]
              })
            );

          return [titleParagraph, ...contentParagraphs, new Paragraph({})]; // ë§ˆì§€ë§‰ì€ ê³µë°± ì¤„
        })
      }]
    });

    const blob = await Packer.toBlob(doc);
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "ì „ì²´_ê¸€ì±….docx";
    a.click();
  }
</script>
</body>
</html>

